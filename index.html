<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>KALAF SOFT - Sistema Check List de Paquetes</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìã</text></svg>">

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

<style>
:root {
--primary-color: #1e3a8a;
--primary-light: #3b82f6;
--secondary-color: #059669;
--secondary-light: #10b981;
--accent-color: #dc2626;
--accent-light: #ef4444;
--warning-color: #d97706;
--warning-light: #f59e0b;
--dark-color: #1f2937;
--light-color: #f8fafc;
--border-radius: 12px;
--shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
--shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
--transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}

* {
margin: 0;
padding: 0;
box-sizing: border-box;
}

body {
font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
color: var(--dark-color);
line-height: 1.6;
}

.app-container {
min-height: 100vh;
display: flex;
flex-direction: column;
}

.app-header {
background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);
color: white;
padding: 1rem 2rem;
box-shadow: var(--shadow-lg);
position: relative;
}

.version {
position: absolute;
top: 10px;
right: 20px;
background: rgba(255, 255, 255, 0.2);
padding: 4px 8px;
border-radius: 4px;
font-size: 0.8rem;
font-weight: 500;
}

.connection-status {
position: absolute;
top: 10px;
left: 20px;
width: 12px;
height: 12px;
background: var(--secondary-light);
border-radius: 50%;
box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
}

.connection-status.offline {
background: var(--accent-light);
box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
}

.logo-section {
display: flex;
align-items: center;
gap: 1rem;
margin-top: 1rem;
}

.logo {
font-size: 3rem;
line-height: 1;
}

.company-info h1 {
font-size: 2rem;
font-weight: 700;
margin-bottom: 0.25rem;
}

.company-info p {
font-size: 1.1rem;
opacity: 0.9;
font-weight: 300;
}

.main-content {
flex: 1;
padding: 2rem;
max-width: 1200px;
margin: 0 auto;
width: 100%;
}

.card {
background: white;
border-radius: var(--border-radius);
box-shadow: var(--shadow);
margin-bottom: 2rem;
overflow: hidden;
border: 1px solid rgba(0, 0, 0, 0.05);
}

.card-header {
background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
padding: 1rem 1.5rem;
border-bottom: 1px solid #e2e8f0;
font-weight: 600;
font-size: 1.1rem;
display: flex;
align-items: center;
gap: 0.5rem;
color: var(--dark-color);
}

.card-body {
padding: 1.5rem;
}

.alert {
padding: 1rem 1.5rem;
margin-bottom: 1rem;
border-radius: var(--border-radius);
display: none;
font-weight: 500;
}

.alert-success {
background: #d1fae5;
color: #065f46;
border: 1px solid #a7f3d0;
}

.alert-error {
background: #fee2e2;
color: #991b1b;
border: 1px solid #fecaca;
}

.alert-warning {
background: #fef3c7;
color: #92400e;
border: 1px solid #fde68a;
}

.file-input-wrapper {
position: relative;
margin-bottom: 1rem;
}

.file-input {
position: absolute;
opacity: 0;
width: 0;
height: 0;
}

.file-input-label {
display: inline-flex;
align-items: center;
gap: 0.5rem;
padding: 0.75rem 1.5rem;
background: var(--primary-color);
color: white;
border-radius: var(--border-radius);
cursor: pointer;
font-weight: 500;
transition: var(--transition);
box-shadow: var(--shadow);
}

.file-input-label:hover {
background: var(--primary-light);
transform: translateY(-1px);
box-shadow: var(--shadow-lg);
}

.file-input-label.has-file {
background: var(--secondary-color);
}

.btn {
display: inline-flex;
align-items: center;
gap: 0.5rem;
padding: 0.75rem 1.5rem;
border: none;
border-radius: var(--border-radius);
font-weight: 500;
cursor: pointer;
transition: var(--transition);
font-size: 1rem;
box-shadow: var(--shadow);
margin-right: 0.5rem;
margin-bottom: 0.5rem;
}

.btn:disabled {
opacity: 0.5;
cursor: not-allowed;
transform: none !important;
}

.btn:hover:not(:disabled) {
transform: translateY(-1px);
box-shadow: var(--shadow-lg);
}

.btn-danger {
background: var(--accent-color);
color: white;
}

.btn-danger:hover:not(:disabled) {
background: var(--accent-light);
}

.btn-success {
background: var(--secondary-color);
color: white;
}

.btn-success:hover:not(:disabled) {
background: var(--secondary-light);
}

.btn-warning {
background: var(--warning-color);
color: white;
}

.btn-warning:hover:not(:disabled) {
background: var(--warning-light);
}

.btn-small {
padding: 0.5rem 1rem;
font-size: 0.9rem;
}

/* Controles simples para poca luz */
.light-controls {
display: none;
background: #f8fafc;
border: 1px solid #e2e8f0;
border-radius: var(--border-radius);
padding: 1rem;
margin-bottom: 1rem;
}

.light-controls.show {
display: block;
}

.light-controls h4 {
margin: 0 0 0.75rem 0;
color: var(--dark-color);
font-size: 1rem;
}

.control-group {
display: flex;
gap: 0.5rem;
flex-wrap: wrap;
align-items: center;
}

.metrics-grid {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
gap: 1rem;
margin-bottom: 2rem;
}

.metric-card {
background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
padding: 1.5rem;
border-radius: var(--border-radius);
text-align: center;
border: 2px solid transparent;
transition: var(--transition);
}

.metric-card.total {
border-color: var(--primary-light);
background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
}

.metric-card.success {
border-color: var(--secondary-light);
background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
}

.metric-card.pending {
border-color: var(--warning-light);
background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
}

.metric-value {
font-size: 2.5rem;
font-weight: 700;
color: var(--dark-color);
line-height: 1;
}

.metric-label {
font-size: 0.9rem;
color: #6b7280;
font-weight: 500;
margin-top: 0.5rem;
}

.progress-container {
margin-top: 1rem;
}

.progress-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 0.5rem;
}

.progress-label {
font-weight: 600;
color: var(--dark-color);
}

.progress-percentage {
font-weight: 700;
color: var(--primary-color);
}

.progress-bar {
background: #e5e7eb;
height: 12px;
border-radius: 6px;
overflow: hidden;
box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
}

.progress-fill {
background: linear-gradient(90deg, var(--primary-color) 0%, var(--primary-light) 100%);
height: 100%;
width: 0%;
transition: width 0.5s ease;
box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.camera-container {
position: relative;
background: #000;
border-radius: var(--border-radius);
overflow: hidden;
aspect-ratio: 16/9;
max-height: 400px;
}

.camera-container.enhanced {
filter: brightness(1.3) contrast(1.4);
}

.camera-placeholder {
display: flex;
flex-direction: column;
align-items: center;
justify-content: center;
height: 100%;
color: #9ca3af;
font-size: 1.1rem;
}

.camera-placeholder i {
font-size: 3rem;
margin-bottom: 1rem;
opacity: 0.5;
}

.camera-overlay {
position: absolute;
top: 0;
left: 0;
width: 100%;
height: 100%;
pointer-events: none;
z-index: 10;
}

#scanner_canvas {
position: absolute;
top: 0;
left: 0;
width: 100% !important;
height: 100% !important;
}

.fardos-grid {
display: grid;
grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
gap: 1rem;
max-height: 400px;
overflow-y: auto;
}

.fardo-item {
background: white;
border: 2px solid #e5e7eb;
border-radius: var(--border-radius);
padding: 1rem;
text-align: center;
font-weight: 600;
transition: var(--transition);
cursor: pointer;
}

.fardo-item:hover {
border-color: var(--primary-light);
transform: translateY(-2px);
box-shadow: var(--shadow);
}

.fardo-item.completed {
background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
border-color: var(--secondary-light);
color: var(--secondary-color);
}

.app-footer {
background: var(--dark-color);
color: white;
padding: 1rem 2rem;
display: flex;
justify-content: space-between;
align-items: center;
font-size: 0.9rem;
}

.status {
display: flex;
align-items: center;
gap: 0.5rem;
}

.scan-notification {
position: fixed;
top: 50%;
left: 50%;
transform: translate(-50%, -50%);
background: var(--secondary-color);
color: white;
padding: 1rem 2rem;
border-radius: var(--border-radius);
font-weight: 600;
font-size: 1.2rem;
z-index: 1000;
box-shadow: var(--shadow-lg);
display: none;
}

.scan-notification.warning {
background: var(--warning-color);
}

.scan-notification.error {
background: var(--accent-color);
}

.loading-spinner {
width: 20px;
height: 20px;
border: 2px solid #f3f4f6;
border-top: 2px solid var(--primary-color);
border-radius: 50%;
animation: spin 1s linear infinite;
}

@keyframes spin {
0% { transform: rotate(0deg); }
100% { transform: rotate(360deg); }
}

@media (max-width: 768px) {
.main-content {
padding: 1rem;
}

.app-header {
padding: 1rem;
}

.logo-section {
flex-direction: column;
text-align: center;
gap: 0.5rem;
}

.company-info h1 {
font-size: 1.5rem;
}

.metrics-grid {
grid-template-columns: 1fr;
}

.fardos-grid {
grid-template-columns: 1fr;
}

.control-group {
justify-content: center;
}
}
</style>
</head>
<body>
<div class="app-container">
<!-- Header profesional -->
<header class="app-header">
<div class="version">v2.1.1</div>
<div class="connection-status" id="connection-status"></div>
<div class="logo-section">
<div class="logo">üìã</div>
<div class="company-info">
<h1>KALAF SOFT</h1>
<p>Sistema Check List de Paquetes de Piso</p>
</div>
</div>
</header>

<main class="main-content">
<!-- Sistema de alertas -->
<div class="alert alert-error" id="alert-error"></div>
<div class="alert alert-success" id="alert-success"></div>
<div class="alert alert-warning" id="alert-warning"></div>

<!-- Configuraci√≥n del sistema -->
<div class="card">
<div class="card-header">
<i class="fas fa-cog"></i>
Configuraci√≥n del Sistema
</div>
<div class="card-body">
<div class="file-input-wrapper">
<input type="file" id="fileInput" class="file-input" accept=".xlsx, .xls" />
<label for="fileInput" class="file-input-label" id="file-label">
<i class="fas fa-upload"></i>
<span>Seleccionar Archivo Excel</span>
</label>
</div>
<button id="start-button" class="btn btn-danger" disabled>
<i class="fas fa-camera"></i>
<span>Activar Esc√°ner</span>
</button>
</div>
</div>

<!-- Dashboard de m√©tricas -->
<div class="card">
<div class="card-header">
<i class="fas fa-chart-bar"></i>
Panel de Control
</div>
<div class="card-body">
<div class="metrics-grid">
<div class="metric-card total">
<div class="metric-value" id="total-count">0</div>
<div class="metric-label">Total</div>
</div>
<div class="metric-card success">
<div class="metric-value" id="completed-count">0</div>
<div class="metric-label">Completados</div>
</div>
<div class="metric-card pending">
<div class="metric-value" id="pending-count">0</div>
<div class="metric-label">Pendientes</div>
</div>
</div>

<div class="progress-container">
<div class="progress-header">
<span class="progress-label">Progreso General</span>
<span class="progress-percentage" id="progress-percentage">0%</span>
</div>
<div class="progress-bar">
<div class="progress-fill" id="progress-fill"></div>
</div>
</div>
</div>
</div>

<!-- C√°mara del esc√°ner -->
<div class="card">
<div class="card-header">
<i class="fas fa-qrcode"></i>
Esc√°ner de C√≥digos de Barras
</div>
<div class="card-body">
<!-- Controles simples para poca luz -->
<div class="light-controls" id="light-controls">
<h4><i class="fas fa-adjust"></i> Mejoras para Poca Luz</h4>
<div class="control-group">
<button id="enhance-btn" class="btn btn-warning btn-small">
<i class="fas fa-sun"></i> Mejorar Brillo
</button>
<button id="torch-btn" class="btn btn-warning btn-small" style="display: none;">
<i class="fas fa-flashlight"></i> Flash
</button>
<button id="reset-btn" class="btn btn-success btn-small">
<i class="fas fa-refresh"></i> Normal
</button>
</div>
</div>

<div class="camera-container" id="camera-container">
<div class="camera-placeholder" id="camera-placeholder">
<i class="fas fa-camera"></i>
<div>Presiona "Activar Esc√°ner" para comenzar</div>
</div>
<div class="camera-overlay"></div>
</div>
</div>
</div>

<!-- Lista de paquetes -->
<div class="card">
<div class="card-header">
<i class="fas fa-list-check"></i>
Lista de Paquetes de Piso
<span class="loading-spinner" id="loading-spinner" style="display: none; margin-left: auto;"></span>
</div>
<div class="card-body">
<div class="fardos-grid" id="fardos-grid">
<div style="grid-column: 1 / -1; text-align: center; color: #9ca3af; padding: 40px 20px; font-size: 14px;">
<i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 16px; display: block;"></i>
Carga un archivo Excel para mostrar los paquetes
</div>
</div>
</div>
</div>
</main>

<!-- Footer de la app -->
<footer class="app-footer">
<div class="status">
<i class="fas fa-shield-check"></i>
Sistema Activo
</div>
<div>¬© 2024 KALAF SOFT</div>
</footer>

<!-- Notificaci√≥n de escaneo -->
<div class="scan-notification" id="scan-notification"></div>
</div>

<script>
// Variables del sistema
let fardos = [];
let isQuaggaStarted = false;
let systemReady = false;
let currentTrack = null;
let enhanced = false;
let torchEnabled = false;

// Referencias a elementos DOM
const elements = {
fileInput: document.getElementById("fileInput"),
fileLabel: document.getElementById("file-label"),
startButton: document.getElementById("start-button"),
cameraContainer: document.getElementById("camera-container"),
cameraPlaceholder: document.getElementById("camera-placeholder"),
fardosGrid: document.getElementById("fardos-grid"),
scanNotification: document.getElementById("scan-notification"),
connectionStatus: document.getElementById("connection-status"),
loadingSpinner: document.getElementById("loading-spinner"),

// Contadores
totalCount: document.getElementById("total-count"),
completedCount: document.getElementById("completed-count"),
pendingCount: document.getElementById("pending-count"),
progressFill: document.getElementById("progress-fill"),
progressPercentage: document.getElementById("progress-percentage"),

// Alertas
alertError: document.getElementById("alert-error"),
alertSuccess: document.getElementById("alert-success"),
alertWarning: document.getElementById("alert-warning"),

// Controles de luz
lightControls: document.getElementById("light-controls"),
enhanceBtn: document.getElementById("enhance-btn"),
torchBtn: document.getElementById("torch-btn"),
resetBtn: document.getElementById("reset-btn")
};

// Sistema de sonido mejorado - SOLO MP3, SIN FALLBACK
class SoundSystem {
    static init() {
        this.audioLoaded = false;
        this.audioElement = null;
        this.userInteracted = false;
        
        console.log('üéµ Inicializando sistema de audio - SOLO MP3');
        
        // Detectar primera interacci√≥n del usuario
        this.setupUserInteraction();
        
        // Crear m√∫ltiples instancias para mejor compatibilidad
        this.createAudioInstances();
        
        // Intentar cargar de diferentes maneras
        this.tryLoadAudio();
    }
    
    static setupUserInteraction() {
        // Detectar cuando el usuario hace clic en cualquier parte
        const enableAudio = () => {
            if (!this.userInteracted) {
                this.userInteracted = true;
                console.log('‚úÖ Interacci√≥n del usuario detectada - Audio habilitado');
                
                // Crear contexto de audio si es necesario
                if (typeof AudioContext !== 'undefined' || typeof webkitAudioContext !== 'undefined') {
                    const AudioCtx = window.AudioContext || window.webkitAudioContext;
                    if (!this.audioContext) {
                        this.audioContext = new AudioCtx();
                        if (this.audioContext.state === 'suspended') {
                            this.audioContext.resume();
                        }
                    }
                }
                
                // Pre-cargar el audio despu√©s de la interacci√≥n
                if (this.beepAudio && this.audioLoaded) {
                    this.beepAudio.load();
                }
            }
        };
        
        // Escuchar m√∫ltiples eventos de interacci√≥n
        ['click', 'touchstart', 'keydown'].forEach(event => {
            document.addEventListener(event, enableAudio, { once: true });
        });
    }
    
    static createAudioInstances() {
        // Crear el elemento de audio principal
        this.beepAudio = new Audio();
        this.beepAudio.preload = 'auto';
        this.beepAudio.volume = 0.8;
        
        // Rutas para GitHub y local
        const possiblePaths = [
            // Para GitHub Pages y repositorio
            './store-scanner-beep-90395.mp3',
            'store-scanner-beep-90395.mp3',
            '/store-scanner-beep-90395.mp3',
            // Para acceso directo en GitHub (raw)
            `${window.location.origin}${window.location.pathname.replace('index.html', '')}store-scanner-beep-90395.mp3`,
            // Ruta relativa m√°s espec√≠fica
            `${window.location.href.replace(/\/[^\/]*$/, '')}/store-scanner-beep-90395.mp3`
        ];
        
        console.log('üîç Rutas a probar:', possiblePaths);
        
        this.audioInstances = possiblePaths.map(path => {
            const audio = new Audio(path);
            audio.preload = 'auto';
            audio.volume = 0.8;
            audio.crossOrigin = "anonymous"; // Para GitHub
            return { audio, path };
        });
    }
    
    static tryLoadAudio() {
        console.log('üîÑ Intentando cargar archivo de audio...');
        
        // Probar cada instancia
        this.audioInstances.forEach((instance, index) => {
            const { audio, path } = instance;
            
            audio.addEventListener('loadeddata', () => {
                if (!this.audioLoaded) {
                    console.log(`‚úÖ Audio cargado exitosamente desde: ${path}`);
                    this.beepAudio = audio;
                    this.audioLoaded = true;
                    this.audioElement = audio;
                }
            });
            
            audio.addEventListener('canplaythrough', () => {
                if (!this.audioLoaded) {
                    console.log(`‚úÖ Audio listo para reproducir desde: ${path} - Duraci√≥n: ${audio.duration}s`);
                    this.beepAudio = audio;
                    this.audioLoaded = true;
                    this.audioElement = audio;
                }
            });
            
            audio.addEventListener('error', (e) => {
                console.log(`‚ùå Error cargando desde ${path}:`, e);
            });
            
            // Cargar el audio
            audio.load();
        });
        
        // Verificar carga despu√©s de 3 segundos
        setTimeout(() => {
            if (!this.audioLoaded) {
                console.log('‚ö†Ô∏è Reintentando carga de audio...');
                this.forceLoadAudio();
            }
        }, 3000);
        
        // Verificar nuevamente despu√©s de 6 segundos
        setTimeout(() => {
            if (!this.audioLoaded) {
                console.error('‚ùå ERROR CR√çTICO: No se pudo cargar el archivo de audio despu√©s de m√∫ltiples intentos');
                console.log('üìÅ Verifica que el archivo store-scanner-beep-90395.mp3 est√© en la misma carpeta que index.html');
                console.log('üåê Aseg√∫rate de estar ejecutando desde un servidor web, no file://');
            }
        }, 6000);
    }
    
    static forceLoadAudio() {
        console.log('üöÄ Forzando carga de audio...');
        
        // Crear una nueva instancia con evento de usuario
        const newAudio = new Audio('./store-scanner-beep-90395.mp3');
        newAudio.volume = 0.8;
        
        // Intentar cargar inmediatamente
        const loadPromise = newAudio.load();
        
        newAudio.addEventListener('loadeddata', () => {
            console.log('‚úÖ Audio forzado cargado exitosamente');
            this.beepAudio = newAudio;
            this.audioLoaded = true;
            this.audioElement = newAudio;
        });
        
        newAudio.addEventListener('error', (e) => {
            console.error('‚ùå Error en carga forzada:', e);
        });
    }
    
    static async playBeep() {
        console.log('üîä Reproduciendo beep - Estado cargado:', this.audioLoaded, '- Usuario interactu√≥:', this.userInteracted);
        
        // Verificar interacci√≥n del usuario
        if (!this.userInteracted) {
            console.log('‚ö†Ô∏è Esperando interacci√≥n del usuario para reproducir audio');
            return;
        }
        
        if (!this.audioLoaded || !this.beepAudio) {
            console.error('‚ùå AUDIO NO DISPONIBLE - El archivo MP3 no se ha cargado');
            console.log('üîß Intentando cargar audio de emergencia...');
            
            // Intentar crear y reproducir inmediatamente
            const emergencyAudio = new Audio('./store-scanner-beep-90395.mp3');
            emergencyAudio.volume = 0.8;
            
            try {
                const playPromise = emergencyAudio.play();
                if (playPromise !== undefined) {
                    await playPromise;
                    console.log('‚úÖ Audio de emergencia reproducido');
                    return;
                }
            } catch (e) {
                console.error('‚ùå Fall√≥ audio de emergencia:', e);
                return;
            }
        }
        
        try {
            console.log('üéµ Reproduciendo archivo MP3 principal');
            
            // Resetear el audio al inicio
            this.beepAudio.currentTime = 0;
            
            // Asegurar volumen
            this.beepAudio.volume = 0.8;
            
            // Reproducir
            const playPromise = this.beepAudio.play();
            
            if (playPromise !== undefined) {
                playPromise
                    .then(() => {
                        console.log('‚úÖ MP3 reproducido exitosamente');
                    })
                    .catch(async (e) => {
                        console.error('‚ùå Error reproduciendo MP3:', e);
                        console.log('üîÑ Reintentando reproducci√≥n...');
                        
                        // Reintentar una vez m√°s
                        try {
                            this.beepAudio.load();
                            await new Promise(resolve => setTimeout(resolve, 100));
                            this.beepAudio.currentTime = 0;
                            await this.beepAudio.play();
                            console.log('‚úÖ MP3 reproducido en reintento');
                        } catch (retryError) {
                            console.error('‚ùå Error en reintento:', retryError);
                        }
                    });
            } else {
                console.log('‚úÖ MP3 reproducido (navegador antiguo)');
            }
            
        } catch (e) {
            console.error('‚ùå Error cr√≠tico reproduciendo audio:', e);
        }
    }
    
    static playSuccessSound() {
        console.log('üéâ Reproduciendo sonido de √©xito (3 beeps)');
        
        // Reproducir 3 veces con intervalos
        this.playBeep();
        setTimeout(() => this.playBeep(), 200);
        setTimeout(() => this.playBeep(), 400);
    }
    
    static testAudio() {
        console.log('üß™ === DIAGN√ìSTICO DE AUDIO ===');
        console.log('Estado del sistema:');
        console.log('- audioLoaded:', this.audioLoaded);
        console.log('- userInteracted:', this.userInteracted);
        console.log('- beepAudio existe:', !!this.beepAudio);
        console.log('- readyState:', this.beepAudio?.readyState);
        console.log('- duration:', this.beepAudio?.duration);
        console.log('- src:', this.beepAudio?.src);
        console.log('- volume:', this.beepAudio?.volume);
        console.log('===============================');
        
        if (!this.userInteracted) {
            console.log('‚ö†Ô∏è NOTA: Necesitas hacer clic en la p√°gina primero para habilitar audio');
            console.log('üñ±Ô∏è Haz clic en cualquier parte de la p√°gina y luego ejecuta: SoundSystem.testAudio()');
        } else {
            console.log('üéµ Probando reproducci√≥n...');
            this.playBeep();
        }
    }
}

// Sistema de notificaciones
class NotificationSystem {
    static show(type, message, duration = 5000) {
        const alert = elements[`alert${type.charAt(0).toUpperCase() + type.slice(1)}`];
        if (!alert) return;

        alert.textContent = message;
        alert.style.display = 'block';

        setTimeout(() => {
            alert.style.display = 'none';
        }, duration);

        // Ocultar otras alertas
        ['error', 'success', 'warning'].forEach(t => {
            if (t !== type) {
                elements[`alert${t.charAt(0).toUpperCase() + t.slice(1)}`].style.display = 'none';
            }
        });
    }

    static hide() {
        ['error', 'success', 'warning'].forEach(type => {
            elements[`alert${type.charAt(0).toUpperCase() + type.slice(1)}`].style.display = 'none';
        });
    }
}

// Sistema de m√©tricas
class MetricsSystem {
    static update() {
        const total = fardos.length;
        const completed = fardos.filter(f => f.revisado).length;
        const pending = total - completed;
        const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;

        elements.totalCount.textContent = total;
        elements.completedCount.textContent = completed;
        elements.pendingCount.textContent = pending;
        elements.progressFill.style.width = `${percentage}%`;
        elements.progressPercentage.textContent = `${percentage}%`;

        // Actualizar estado de conexi√≥n
        elements.connectionStatus.className = systemReady ? 'connection-status' : 'connection-status offline';

        // Verificar completado
        if (total > 0 && completed === total) {
            NotificationSystem.show('success', `üéâ ¬°Excelente! Todos los ${total} paquetes han sido procesados correctamente.`);
            this.triggerCompletionEffects();
        }
    }

    static triggerCompletionEffects() {
        // Vibraci√≥n de √©xito
        if ('vibrate' in navigator) {
            navigator.vibrate([200, 100, 200, 100, 200]);
        }

        // Sonido de √©xito
        SoundSystem.playSuccessSound();

        // Efecto visual en la barra de progreso
        elements.progressFill.style.background = 'linear-gradient(90deg, #10b981 0%, #34d399 50%, #10b981 100%)';
        elements.progressFill.style.boxShadow = '0 0 20px rgba(16, 185, 129, 0.5)';
    }
}

// Sistema de archivos
class FileSystem {
    static init() {
        elements.fileInput.addEventListener('change', this.handleFileChange.bind(this));
    }

    static handleFileChange(event) {
        const file = event.target.files[0];
        const label = elements.fileLabel;

        if (!file) {
            this.resetFileInput();
            return;
        }

        // Actualizar UI del input
        label.classList.add('has-file');
        label.innerHTML = `<i class="fas fa-file-excel"></i><span>${file.name}</span>`;

        // Mostrar loading
        elements.loadingSpinner.style.display = 'block';
        NotificationSystem.show('warning', 'Procesando archivo Excel...');

        // Procesar archivo
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheet = workbook.Sheets["Packing List"];

                if (!sheet) {
                    throw new Error('La hoja "Packing List" no fue encontrada en el archivo');
                }

                const rawData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                this.procesarDatos(rawData);

            } catch (error) {
                console.error('Error al procesar archivo:', error);
                NotificationSystem.show('error', `‚ùå Error: ${error.message}`);
                this.resetFileInput();
            } finally {
                elements.loadingSpinner.style.display = 'none';
            }
        };

        reader.readAsArrayBuffer(file);
    }

    static resetFileInput() {
        const label = elements.fileLabel;
        label.classList.remove('has-file');
        label.innerHTML = '<i class="fas fa-upload"></i><span>Seleccionar Archivo Excel</span>';
        elements.fileInput.value = '';
        elements.startButton.disabled = true;
        systemReady = false;
        MetricsSystem.update();
    }

    static procesarDatos(rawData) {
        const fardosUnicos = new Set();

        // Extraer paquetes √∫nicos del archivo Excel
        for (let i = 12; i < rawData.length; i++) {
            const fila = rawData[i];
            if (fila && fila[1]) {
                fardosUnicos.add(fila[1].toString().trim());
            }
        }

        // Convertir a array de objetos
        fardos = Array.from(fardosUnicos).map((paquete) => ({
            paquete: paquete,
            revisado: false,
            timestamp: null
        }));

        if (fardos.length > 0) {
            NotificationSystem.show('success', `‚úÖ Se cargaron ${fardos.length} paquetes correctamente.`);
            elements.startButton.disabled = false;
            systemReady = true;
            this.renderFardosList();
        } else {
            NotificationSystem.show('error', '‚ùå No se encontraron paquetes v√°lidos en el archivo.');
            systemReady = false;
        }

        MetricsSystem.update();
    }

    static renderFardosList() {
        const grid = elements.fardosGrid;
        grid.innerHTML = '';

        fardos.forEach((fardo, index) => {
            const item = document.createElement('div');
            item.className = 'fardo-item';
            item.textContent = fardo.paquete;
            item.id = `fardo-${index}`;

            if (fardo.revisado) {
                item.classList.add('completed');
            }

            grid.appendChild(item);
        });
    }
}

// Sistema de c√°mara y esc√°ner
class ScannerSystem {
    static init() {
        elements.startButton.addEventListener('click', this.handleStartScanner.bind(this));
        
        // Configurar controles simples
        elements.enhanceBtn.addEventListener('click', this.enhanceCamera.bind(this));
        elements.torchBtn.addEventListener('click', this.toggleTorch.bind(this));
        elements.resetBtn.addEventListener('click', this.resetCamera.bind(this));
    }

    static handleStartScanner() {
        if (!systemReady) {
            NotificationSystem.show('warning', '‚ö†Ô∏è Primero debe cargar un archivo Excel con los paquetes.');
            return;
        }

        if (!isQuaggaStarted) {
            NotificationSystem.hide();
            this.startQuagga();
        } else {
            // Detener esc√°ner si ya est√° iniciado
            this.stopScanner();
        }
    }

    static stopScanner() {
        Quagga.stop();
        isQuaggaStarted = false;
        
        // Limpiar track de c√°mara
        if (currentTrack) {
            currentTrack.stop();
            currentTrack = null;
        }
        
        elements.startButton.innerHTML = '<i class="fas fa-camera"></i><span>Activar Esc√°ner</span>';
        elements.startButton.className = "btn btn-danger";
        elements.cameraPlaceholder.style.display = "block";
        elements.lightControls.classList.remove('show');
        
        // Reset visual
        elements.cameraContainer.classList.remove('enhanced');
        enhanced = false;
        torchEnabled = false;
    }

    static startQuagga() {
        // Configuraci√≥n est√°ndar que funciona bien
        Quagga.init({
            inputStream: {
                name: "Live",
                type: "LiveStream",
                target: elements.cameraContainer,
                constraints: {
                    width: { min: 640, ideal: 1280 },
                    height: { min: 480, ideal: 720 },
                    facingMode: "environment"
                }
            },
            decoder: {
                readers: [
                    "code_128_reader", 
                    "ean_reader", 
                    "ean_8_reader",
                    "code_39_reader",
                    "code_39_vin_reader",
                    "codabar_reader",
                    "upc_reader",
                    "upc_e_reader"
                ]
            },
            locator: {
                patchSize: "medium",
                halfSample: true
            },
            numOfWorkers: navigator.hardwareConcurrency || 4,
            locate: true,
            frequency: 10
        }, (err) => {
            if (err) {
                console.error("Error al iniciar Quagga:", err);
                NotificationSystem.show('error', '‚ùå Error al acceder a la c√°mara. Verifique los permisos.');
                elements.cameraPlaceholder.style.display = "block";
                return;
            }

            this.setupCamera();
        });
    }

    static setupCamera() {
        elements.cameraPlaceholder.style.display = "none";
        elements.lightControls.classList.add('show');

        const video = elements.cameraContainer.querySelector("video");
        const canvas = elements.cameraContainer.querySelector("canvas");

        if (video) {
            video.style.display = "block";
            video.style.width = "100%";
            video.style.height = "100%";
            video.style.objectFit = "cover";
            
            // Obtener el track de video
            if (video.srcObject) {
                currentTrack = video.srcObject.getVideoTracks()[0];
                this.checkTorchSupport();
            }
        }
        
        if (canvas) {
            canvas.style.display = "block";
            canvas.style.position = "absolute";
            canvas.style.top = "0";
            canvas.style.left = "0";
            canvas.style.width = "100%";
            canvas.style.height = "100%";
        }

        Quagga.start();
        isQuaggaStarted = true;

        elements.startButton.innerHTML = '<i class="fas fa-stop"></i><span>Detener Esc√°ner</span>';
        elements.startButton.className = "btn btn-success";

        NotificationSystem.show('success', '‚úÖ Esc√°ner activado. Use los botones de mejora si hay poca luz.');
    }

    static enhanceCamera() {
        if (!enhanced) {
            elements.cameraContainer.classList.add('enhanced');
            elements.enhanceBtn.innerHTML = '<i class="fas fa-sun"></i> Brillo ON';
            elements.enhanceBtn.classList.remove('btn-warning');
            elements.enhanceBtn.classList.add('btn-success');
            enhanced = true;
            NotificationSystem.show('success', '‚ú® Modo poca luz activado - Mejor brillo y contraste', 2000);
        } else {
            elements.cameraContainer.classList.remove('enhanced');
            elements.enhanceBtn.innerHTML = '<i class="fas fa-sun"></i> Mejorar Brillo';
            elements.enhanceBtn.classList.remove('btn-success');
            elements.enhanceBtn.classList.add('btn-warning');
            enhanced = false;
        }
    }

    static async toggleTorch() {
        if (!currentTrack) return;

        try {
            if (!torchEnabled) {
                await currentTrack.applyConstraints({
                    advanced: [{ torch: true }]
                });
                torchEnabled = true;
                elements.torchBtn.innerHTML = '<i class="fas fa-flashlight"></i> Flash ON';
                elements.torchBtn.classList.remove('btn-warning');
                elements.torchBtn.classList.add('btn-success');
                console.log('üî¶ Flash activado');
            } else {
                await currentTrack.applyConstraints({
                    advanced: [{ torch: false }]
                });
                torchEnabled = false;
                elements.torchBtn.innerHTML = '<i class="fas fa-flashlight"></i> Flash';
                elements.torchBtn.classList.remove('btn-success');
                elements.torchBtn.classList.add('btn-warning');
                console.log('üî¶ Flash desactivado');
            }
        } catch (e) {
            console.log('‚ö†Ô∏è Flash no soportado en este dispositivo');
        }
    }

    static resetCamera() {
        elements.cameraContainer.classList.remove('enhanced');
        elements.enhanceBtn.innerHTML = '<i class="fas fa-sun"></i> Mejorar Brillo';
        elements.enhanceBtn.classList.remove('btn-success');
        elements.enhanceBtn.classList.add('btn-warning');
        enhanced = false;
        
        if (torchEnabled) {
            this.toggleTorch();
        }
    }

    static checkTorchSupport() {
        if (!currentTrack) return;
        
        try {
            const capabilities = currentTrack.getCapabilities();
            if (capabilities.torch) {
                elements.torchBtn.style.display = 'block';
                console.log('üî¶ Flash soportado');
            } else {
                elements.torchBtn.style.display = 'none';
                console.log('‚ùå Flash no soportado');
            }
        } catch (e) {
            elements.torchBtn.style.display = 'none';
        }
    }

    static showScanNotification(message, type = 'success') {
        const notification = elements.scanNotification;
        notification.textContent = message;
        notification.className = `scan-notification ${type}`;
        notification.style.display = 'block';

        setTimeout(() => {
            notification.style.display = 'none';
        }, type === 'warning' ? 1500 : 2000);
    }

    static processBarcodeDetection(code) {
        const cleanCode = code.trim();
        console.log('C√≥digo detectado:', cleanCode);

        // Buscar el paquete en la lista
        const fardoIndex = fardos.findIndex(f => f.paquete === cleanCode);

        if (fardoIndex !== -1) {
            const fardo = fardos[fardoIndex];

            if (!fardo.revisado) {
                // Marcar como completado
                fardo.revisado = true;
                fardo.timestamp = new Date();

                // Actualizar UI
                const fardoElement = document.getElementById(`fardo-${fardoIndex}`);
                if (fardoElement) {
                    fardoElement.classList.add('completed');
                }

                // Efectos de √©xito
                SoundSystem.playBeep();
                this.showScanNotification(`‚úÖ Paquete ${cleanCode} registrado correctamente`, 'success');

                // Vibraci√≥n
                if ('vibrate' in navigator) {
                    navigator.vibrate([100]);
                }

                // Actualizar m√©tricas
                MetricsSystem.update();

            } else {
                // Ya fue escaneado
                SoundSystem.playBeep();
                this.showScanNotification(`‚ö†Ô∏è Paquete ${cleanCode} ya fue registrado`, 'warning');
            }
        } else {
            // Paquete no encontrado
            this.showScanNotification(`‚ùå Paquete ${cleanCode} no est√° en la lista`, 'error');
        }
    }
}

// Variables para evitar detecciones m√∫ltiples
let lastDetectedCode = null;
let lastDetectedTime = 0;
const DETECTION_COOLDOWN = 2000; // 2 segundos entre detecciones del mismo c√≥digo

// Evento de detecci√≥n de c√≥digo de barras
Quagga.onDetected(function(result) {
    const code = result.codeResult.code;
    const currentTime = Date.now();

    // Evitar detecciones repetidas
    if (code === lastDetectedCode && (currentTime - lastDetectedTime) < DETECTION_COOLDOWN) {
        return;
    }

    lastDetectedCode = code;
    lastDetectedTime = currentTime;

    // Procesar el c√≥digo detectado
    ScannerSystem.processBarcodeDetection(code);
});

// Dibujar overlay en la c√°mara (versi√≥n simplificada que funciona)
Quagga.onProcessed(function (result) {
    const drawingCtx = Quagga.canvas.ctx.overlay;
    const drawingCanvas = Quagga.canvas.dom.overlay;

    if (!drawingCtx || !drawingCanvas) return;

    drawingCtx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);

    // Dibujar cuadro de escaneo fijo en el centro
    const rectWidth = drawingCanvas.width * 0.7;
    const rectHeight = drawingCanvas.height * 0.3;
    const rectX = (drawingCanvas.width - rectWidth) / 2;
    const rectY = (drawingCanvas.height - rectHeight) / 2;

    // Cuadro principal
    drawingCtx.lineWidth = 3;
    drawingCtx.strokeStyle = enhanced ? '#f59e0b' : '#10b981';
    drawingCtx.fillStyle = enhanced ? 'rgba(245, 158, 11, 0.1)' : 'rgba(16, 185, 129, 0.1)';
    drawingCtx.fillRect(rectX, rectY, rectWidth, rectHeight);
    drawingCtx.strokeRect(rectX, rectY, rectWidth, rectHeight);

    // Esquinas del cuadro de escaneo
    const cornerLength = 20;
    const cornerThickness = 4;
    drawingCtx.lineWidth = cornerThickness;
    drawingCtx.strokeStyle = '#ffffff';

    // Esquina superior izquierda
    drawingCtx.beginPath();
    drawingCtx.moveTo(rectX, rectY + cornerLength);
    drawingCtx.lineTo(rectX, rectY);
    drawingCtx.lineTo(rectX + cornerLength, rectY);
    drawingCtx.stroke();

    // Esquina superior derecha
    drawingCtx.beginPath();
    drawingCtx.moveTo(rectX + rectWidth - cornerLength, rectY);
    drawingCtx.lineTo(rectX + rectWidth, rectY);
    drawingCtx.lineTo(rectX + rectWidth, rectY + cornerLength);
    drawingCtx.stroke();

    // Esquina inferior izquierda
    drawingCtx.beginPath();
    drawingCtx.moveTo(rectX, rectY + rectHeight - cornerLength);
    drawingCtx.lineTo(rectX, rectY + rectHeight);
    drawingCtx.lineTo(rectX + cornerLength, rectY + rectHeight);
    drawingCtx.stroke();

    // Esquina inferior derecha
    drawingCtx.beginPath();
    drawingCtx.moveTo(rectX + rectWidth - cornerLength, rectY + rectHeight);
    drawingCtx.lineTo(rectX + rectWidth, rectY + rectHeight);
    drawingCtx.lineTo(rectX + rectWidth, rectY + rectHeight - cornerLength);
    drawingCtx.stroke();

    // Texto de instrucci√≥n
    drawingCtx.fillStyle = '#ffffff';
    drawingCtx.font = '16px Arial';
    drawingCtx.textAlign = 'center';
    drawingCtx.fillText('Coloque el c√≥digo de barras dentro del marco', 
                       drawingCanvas.width / 2, rectY - 10);

    // Dibujar c√≥digos detectados
    if (result) {
        if (result.boxes) {
            result.boxes
                .filter((box) => box !== result.box)
                .forEach((box) => {
                    drawingCtx.strokeStyle = "rgba(255, 255, 255, 0.4)";
                    drawingCtx.lineWidth = 2;
                    drawingCtx.beginPath();
                    box.forEach((point, index) => {
                        if (index === 0) {
                            drawingCtx.moveTo(point[0], point[1]);
                        } else {
                            drawingCtx.lineTo(point[0], point[1]);
                        }
                    });
                    drawingCtx.closePath();
                    drawingCtx.stroke();
                });
        }

        if (result.box) {
            drawingCtx.strokeStyle = "#00ff00";
            drawingCtx.lineWidth = 3;
            drawingCtx.beginPath();
            result.box.forEach((point, index) => {
                if (index === 0) {
                    drawingCtx.moveTo(point[0], point[1]);
                } else {
                    drawingCtx.lineTo(point[0], point[1]);
                }
            });
            drawingCtx.closePath();
            drawingCtx.stroke();
        }

        if (result.codeResult && result.codeResult.code) {
            drawingCtx.fillStyle = "#00ff00";
            drawingCtx.font = "bold 16px Arial";
            drawingCtx.textAlign = "left";
            drawingCtx.fillText(result.codeResult.code, 10, 30);
        }
    }
});

// Inicializaci√≥n del sistema
document.addEventListener('DOMContentLoaded', function() {
    console.log('Inicializando KALAF SOFT System v2.1.1...');
        
    // Verificar disponibilidad de APIs necesarias
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        NotificationSystem.show('error', '‚ùå Tu navegador no soporta acceso a c√°mara. Usa Chrome o Firefox moderno.');
        return;
    }

    // Inicializar m√≥dulos
    SoundSystem.init();
    FileSystem.init();
    ScannerSystem.init();
    MetricsSystem.update();

    console.log('Sistema inicializado correctamente');
    NotificationSystem.show('success', '‚úÖ Sistema KALAF SOFT listo. Carga un archivo Excel para comenzar.', 3000);
});

// Manejo de errores globales
window.addEventListener('error', function(e) {
    console.error('Error global:', e.error);
    NotificationSystem.show('error', '‚ùå Se produjo un error en el sistema. Recarga la p√°gina si persiste.');
});

// Manejo de permisos de c√°mara
navigator.permissions?.query({name: 'camera'}).then(function(result) {
    console.log('Estado de permisos de c√°mara:', result.state);
    if (result.state === 'denied') {
        NotificationSystem.show('warning', '‚ö†Ô∏è Los permisos de c√°mara est√°n denegados. Habil√≠talos en la configuraci√≥n del navegador.');
    }
});

// Optimizaciones de rendimiento
if ('requestIdleCallback' in window) {
    requestIdleCallback(() => {
        console.log('Optimizaciones de rendimiento aplicadas');
    });
}

// Prevenir zoom en dispositivos m√≥viles
document.addEventListener('touchstart', function(event) {
    if (event.touches.length > 1) {
        event.preventDefault();
    }
});

let lastTouchEnd = 0;
document.addEventListener('touchend', function(event) {
    const now = (new Date()).getTime();
    if (now - lastTouchEnd <= 300) {
        event.preventDefault();
    }
    lastTouchEnd = now;
}, false);
</script>
</body>
</html>
