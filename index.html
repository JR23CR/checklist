<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>KALAF SOFT - Sistema Check List de Paquetes</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>📋</text></svg>">

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

<style>
:root {
--primary-color: #1e3a8a;
--primary-light: #3b82f6;
--secondary-color: #059669;
--secondary-light: #10b981;
--accent-color: #dc2626;
--accent-light: #ef4444;
--warning-color: #d97706;
--warning-light: #f59e0b;
--dark-color: #1f2937;
--light-color: #f8fafc;
--border-radius: 12px;
--shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
--shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
--transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}

* {
margin: 0;
padding: 0;
box-sizing: border-box;
}

body {
font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
color: var(--dark-color);
line-height: 1.6;
}

.app-container {
min-height: 100vh;
display: flex;
flex-direction: column;
}

.app-header {
background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);
color: white;
padding: 1rem 2rem;
box-shadow: var(--shadow-lg);
position: relative;
}

.version {
position: absolute;
top: 10px;
right: 20px;
background: rgba(255, 255, 255, 0.2);
padding: 4px 8px;
border-radius: 4px;
font-size: 0.8rem;
font-weight: 500;
}

.connection-status {
position: absolute;
top: 10px;
left: 20px;
width: 12px;
height: 12px;
background: var(--secondary-light);
border-radius: 50%;
box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
}

.connection-status.offline {
background: var(--accent-light);
box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
}

.logo-section {
display: flex;
align-items: center;
gap: 1rem;
margin-top: 1rem;
}

.logo {
font-size: 3rem;
line-height: 1;
}

.company-info h1 {
font-size: 2rem;
font-weight: 700;
margin-bottom: 0.25rem;
}

.company-info p {
font-size: 1.1rem;
opacity: 0.9;
font-weight: 300;
}

.main-content {
flex: 1;
padding: 2rem;
max-width: 1200px;
margin: 0 auto;
width: 100%;
}

.card {
background: white;
border-radius: var(--border-radius);
box-shadow: var(--shadow);
margin-bottom: 2rem;
overflow: hidden;
border: 1px solid rgba(0, 0, 0, 0.05);
}

.card-header {
background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
padding: 1rem 1.5rem;
border-bottom: 1px solid #e2e8f0;
font-weight: 600;
font-size: 1.1rem;
display: flex;
align-items: center;
gap: 0.5rem;
color: var(--dark-color);
}

.card-body {
padding: 1.5rem;
}

.alert {
padding: 1rem 1.5rem;
margin-bottom: 1rem;
border-radius: var(--border-radius);
display: none;
font-weight: 500;
}

.alert-success {
background: #d1fae5;
color: #065f46;
border: 1px solid #a7f3d0;
}

.alert-error {
background: #fee2e2;
color: #991b1b;
border: 1px solid #fecaca;
}

.alert-warning {
background: #fef3c7;
color: #92400e;
border: 1px solid #fde68a;
}

.file-input-wrapper {
position: relative;
margin-bottom: 1rem;
}

.file-input {
position: absolute;
opacity: 0;
width: 0;
height: 0;
}

.file-input-label {
display: inline-flex;
align-items: center;
gap: 0.5rem;
padding: 0.75rem 1.5rem;
background: var(--primary-color);
color: white;
border-radius: var(--border-radius);
cursor: pointer;
font-weight: 500;
transition: var(--transition);
box-shadow: var(--shadow);
}

.file-input-label:hover {
background: var(--primary-light);
transform: translateY(-1px);
box-shadow: var(--shadow-lg);
}

.file-input-label.has-file {
background: var(--secondary-color);
}

.btn {
display: inline-flex;
align-items: center;
gap: 0.5rem;
padding: 0.75rem 1.5rem;
border: none;
border-radius: var(--border-radius);
font-weight: 500;
cursor: pointer;
transition: var(--transition);
font-size: 1rem;
box-shadow: var(--shadow);
}

.btn:disabled {
opacity: 0.5;
cursor: not-allowed;
transform: none !important;
}

.btn:hover:not(:disabled) {
transform: translateY(-1px);
box-shadow: var(--shadow-lg);
}

.btn-danger {
background: var(--accent-color);
color: white;
}

.btn-danger:hover:not(:disabled) {
background: var(--accent-light);
}

.btn-success {
background: var(--secondary-color);
color: white;
}

.btn-success:hover:not(:disabled) {
background: var(--secondary-light);
}

.metrics-grid {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
gap: 1rem;
margin-bottom: 2rem;
}

.metric-card {
background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
padding: 1.5rem;
border-radius: var(--border-radius);
text-align: center;
border: 2px solid transparent;
transition: var(--transition);
}

.metric-card.total {
border-color: var(--primary-light);
background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
}

.metric-card.success {
border-color: var(--secondary-light);
background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
}

.metric-card.pending {
border-color: var(--warning-light);
background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
}

.metric-value {
font-size: 2.5rem;
font-weight: 700;
color: var(--dark-color);
line-height: 1;
}

.metric-label {
font-size: 0.9rem;
color: #6b7280;
font-weight: 500;
margin-top: 0.5rem;
}

.progress-container {
margin-top: 1rem;
}

.progress-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 0.5rem;
}

.progress-label {
font-weight: 600;
color: var(--dark-color);
}

.progress-percentage {
font-weight: 700;
color: var(--primary-color);
}

.progress-bar {
background: #e5e7eb;
height: 12px;
border-radius: 6px;
overflow: hidden;
box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
}

.progress-fill {
background: linear-gradient(90deg, var(--primary-color) 0%, var(--primary-light) 100%);
height: 100%;
width: 0%;
transition: width 0.5s ease;
box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.camera-container {
position: relative;
background: #000;
border-radius: var(--border-radius);
overflow: hidden;
aspect-ratio: 16/9;
max-height: 400px;
}

.camera-placeholder {
display: flex;
flex-direction: column;
align-items: center;
justify-content: center;
height: 100%;
color: #9ca3af;
font-size: 1.1rem;
}

.camera-placeholder i {
font-size: 3rem;
margin-bottom: 1rem;
opacity: 0.5;
}

.camera-overlay {
position: absolute;
top: 0;
left: 0;
width: 100%;
height: 100%;
pointer-events: none;
z-index: 10;
}

#scanner_canvas {
position: absolute;
top: 0;
left: 0;
width: 100% !important;
height: 100% !important;
}

.fardos-grid {
display: grid;
grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
gap: 1rem;
max-height: 400px;
overflow-y: auto;
}

.fardo-item {
background: white;
border: 2px solid #e5e7eb;
border-radius: var(--border-radius);
padding: 1rem;
text-align: center;
font-weight: 600;
transition: var(--transition);
cursor: pointer;
}

.fardo-item:hover {
border-color: var(--primary-light);
transform: translateY(-2px);
box-shadow: var(--shadow);
}

.fardo-item.completed {
background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
border-color: var(--secondary-light);
color: var(--secondary-color);
}

.app-footer {
background: var(--dark-color);
color: white;
padding: 1rem 2rem;
display: flex;
justify-content: space-between;
align-items: center;
font-size: 0.9rem;
}

.status {
display: flex;
align-items: center;
gap: 0.5rem;
}

.scan-notification {
position: fixed;
top: 50%;
left: 50%;
transform: translate(-50%, -50%);
background: var(--secondary-color);
color: white;
padding: 1rem 2rem;
border-radius: var(--border-radius);
font-weight: 600;
font-size: 1.2rem;
z-index: 1000;
box-shadow: var(--shadow-lg);
display: none;
}

.scan-notification.warning {
background: var(--warning-color);
}

.scan-notification.error {
background: var(--accent-color);
}

.loading-spinner {
width: 20px;
height: 20px;
border: 2px solid #f3f4f6;
border-top: 2px solid var(--primary-color);
border-radius: 50%;
animation: spin 1s linear infinite;
}

@keyframes spin {
0% { transform: rotate(0deg); }
100% { transform: rotate(360deg); }
}

@media (max-width: 768px) {
.main-content {
padding: 1rem;
}

.app-header {
padding: 1rem;
}

.logo-section {
flex-direction: column;
text-align: center;
gap: 0.5rem;
}

.company-info h1 {
font-size: 1.5rem;
}

.metrics-grid {
grid-template-columns: 1fr;
}

.fardos-grid {
grid-template-columns: 1fr;
}
}
</style>
</head>
<body>
<div class="app-container">
<!-- Header profesional -->
<header class="app-header">
<div class="version">v2.1.0</div>
<div class="connection-status" id="connection-status"></div>
<div class="logo-section">
<div class="logo">📋</div>
<div class="company-info">
<h1>KALAF SOFT</h1>
<p>Sistema Check List de Paquetes de Piso</p>
</div>
</div>
</header>

<main class="main-content">
<!-- Sistema de alertas -->
<div class="alert alert-error" id="alert-error"></div>
<div class="alert alert-success" id="alert-success"></div>
<div class="alert alert-warning" id="alert-warning"></div>

<!-- Configuración del sistema -->
<div class="card">
<div class="card-header">
<i class="fas fa-cog"></i>
Configuración del Sistema
</div>
<div class="card-body">
<div class="file-input-wrapper">
<input type="file" id="fileInput" class="file-input" accept=".xlsx, .xls" />
<label for="fileInput" class="file-input-label" id="file-label">
<i class="fas fa-upload"></i>
<span>Seleccionar Archivo Excel</span>
</label>
</div>
<button id="start-button" class="btn btn-danger" disabled>
<i class="fas fa-camera"></i>
<span>Activar Escáner</span>
</button>
</div>
</div>

<!-- Dashboard de métricas -->
<div class="card">
<div class="card-header">
<i class="fas fa-chart-bar"></i>
Panel de Control
</div>
<div class="card-body">
<div class="metrics-grid">
<div class="metric-card total">
<div class="metric-value" id="total-count">0</div>
<div class="metric-label">Total</div>
</div>
<div class="metric-card success">
<div class="metric-value" id="completed-count">0</div>
<div class="metric-label">Completados</div>
</div>
<div class="metric-card pending">
<div class="metric-value" id="pending-count">0</div>
<div class="metric-label">Pendientes</div>
</div>
</div>

<div class="progress-container">
<div class="progress-header">
<span class="progress-label">Progreso General</span>
<span class="progress-percentage" id="progress-percentage">0%</span>
</div>
<div class="progress-bar">
<div class="progress-fill" id="progress-fill"></div>
</div>
</div>
</div>
</div>

<!-- Cámara del escáner -->
<div class="card">
<div class="card-header">
<i class="fas fa-qrcode"></i>
Escáner de Códigos de Barras
</div>
<div class="card-body" style="padding: 0;">
<div class="camera-container" id="camera-container">
<div class="camera-placeholder" id="camera-placeholder">
<i class="fas fa-camera"></i>
<div>Presiona "Activar Escáner" para comenzar</div>
</div>
<div class="camera-overlay"></div>
</div>
</div>
</div>

<!-- Lista de paquetes -->
<div class="card">
<div class="card-header">
<i class="fas fa-list-check"></i>
Lista de Paquetes de Piso
<span class="loading-spinner" id="loading-spinner" style="display: none; margin-left: auto;"></span>
</div>
<div class="card-body">
<div class="fardos-grid" id="fardos-grid">
<div style="grid-column: 1 / -1; text-align: center; color: #9ca3af; padding: 40px 20px; font-size: 14px;">
<i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 16px; display: block;"></i>
Carga un archivo Excel para mostrar los paquetes
</div>
</div>
</div>
</div>
</main>

<!-- Footer de la app -->
<footer class="app-footer">
<div class="status">
<i class="fas fa-shield-check"></i>
Sistema Activo
</div>
<div>© 2024 KALAF SOFT</div>
</footer>

<!-- Notificación de escaneo -->
<div class="scan-notification" id="scan-notification"></div>
</div>

<script>
// Variables del sistema
let fardos = [];
let isQuaggaStarted = false;
let systemReady = false;

// Referencias a elementos DOM
const elements = {
fileInput: document.getElementById("fileInput"),
fileLabel: document.getElementById("file-label"),
startButton: document.getElementById("start-button"),
cameraContainer: document.getElementById("camera-container"),
cameraPlaceholder: document.getElementById("camera-placeholder"),
fardosGrid: document.getElementById("fardos-grid"),
scanNotification: document.getElementById("scan-notification"),
connectionStatus: document.getElementById("connection-status"),
loadingSpinner: document.getElementById("loading-spinner"),

// Contadores
totalCount: document.getElementById("total-count"),
completedCount: document.getElementById("completed-count"),
pendingCount: document.getElementById("pending-count"),
progressFill: document.getElementById("progress-fill"),
progressPercentage: document.getElementById("progress-percentage"),

// Alertas
alertError: document.getElementById("alert-error"),
alertSuccess: document.getElementById("alert-success"),
alertWarning: document.getElementById("alert-warning")
};

// Sistema de sonido mejorado
class SoundSystem {
    static init() {
        // Inicializar el audio del beep desde la misma carpeta
        this.beepAudio = new Audio('./store-scanner-beep-90395.mp3');
        this.beepAudio.volume = 0.7;
        this.beepAudio.preload = 'auto';
        
        // Intentar cargar el audio
        this.beepAudio.addEventListener('canplaythrough', () => {
            console.log('Audio del scanner cargado correctamente');
        });
        
        this.beepAudio.addEventListener('error', (e) => {
            console.log('Error al cargar el audio del scanner, usando fallback:', e);
            this.useWebAudioFallback = true;
        });
    }
    
    static playBeep() {
        try {
            if (this.beepAudio && !this.useWebAudioFallback) {
                // Usar el archivo MP3 desde GitHub
                this.beepAudio.currentTime = 0;
                this.beepAudio.play().catch(e => {
                    console.log('Error reproduciendo MP3, usando fallback:', e);
                    this.playWebAudioBeep();
                });
            } else {
                // Fallback a Web Audio API
                this.playWebAudioBeep();
            }
        } catch (e) {
            console.log('Error en playBeep:', e);
            this.playWebAudioBeep();
        }
    }
    
    static playWebAudioBeep() {
        try {
            // Crear beep con Web Audio API como fallback
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
            oscillator.type = 'square';

            gainNode.gain.setValueAtTime(0, audioContext.currentTime);
            gainNode.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + 0.01);
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.3);

            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.3);
        } catch (e) {
            console.log('No se pudo reproducir el sonido fallback:', e);
        }
    }
    
    static playSuccessSound() {
        try {
            // Para el sonido de éxito, usar el mismo beep 3 veces
            this.playBeep();
            setTimeout(() => this.playBeep(), 150);
            setTimeout(() => this.playBeep(), 300);
        } catch (e) {
            console.log('Error en playSuccessSound:', e);
        }
    }
}

// Sistema de notificaciones
class NotificationSystem {
static show(type, message, duration = 5000) {
const alert = elements[`alert${type.charAt(0).toUpperCase() + type.slice(1)}`];
if (!alert) return;

alert.textContent = message;
alert.style.display = 'block';

setTimeout(() => {
alert.style.display = 'none';
}, duration);

// Ocultar otras alertas
['error', 'success', 'warning'].forEach(t => {
if (t !== type) {
elements[`alert${t.charAt(0).toUpperCase() + t.slice(1)}`].style.display = 'none';
}
});
}

static hide() {
['error', 'success', 'warning'].forEach(type => {
elements[`alert${type.charAt(0).toUpperCase() + type.slice(1)}`].style.display = 'none';
});
}
}

// Sistema de métricas
class MetricsSystem {
static update() {
const total = fardos.length;
const completed = fardos.filter(f => f.revisado).length;
const pending = total - completed;
const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;

elements.totalCount.textContent = total;
elements.completedCount.textContent = completed;
elements.pendingCount.textContent = pending;
elements.progressFill.style.width = `${percentage}%`;
elements.progressPercentage.textContent = `${percentage}%`;

// Actualizar estado de conexión
elements.connectionStatus.className = systemReady ? 'connection-status' : 'connection-status offline';

// Verificar completado
if (total > 0 && completed === total) {
NotificationSystem.show('success', `🎉 ¡Excelente! Todos los ${total} paquetes han sido procesados correctamente.`);
this.triggerCompletionEffects();
}
}

static triggerCompletionEffects() {
// Vibración de éxito
if ('vibrate' in navigator) {
navigator.vibrate([200, 100, 200, 100, 200]);
}

// Sonido de éxito
SoundSystem.playSuccessSound();

// Efecto visual en la barra de progreso
elements.progressFill.style.background = 'linear-gradient(90deg, #10b981 0%, #34d399 50%, #10b981 100%)';
elements.progressFill.style.boxShadow = '0 0 20px rgba(16, 185, 129, 0.5)';
}
}

// Sistema de archivos
class FileSystem {
static init() {
elements.fileInput.addEventListener('change', this.handleFileChange.bind(this));
}

static handleFileChange(event) {
const file = event.target.files[0];
const label = elements.fileLabel;

if (!file) {
this.resetFileInput();
return;
}

// Actualizar UI del input
label.classList.add('has-file');
label.innerHTML = `<i class="fas fa-file-excel"></i><span>${file.name}</span>`;

// Mostrar loading
elements.loadingSpinner.style.display = 'block';
NotificationSystem.show('warning', 'Procesando archivo Excel...');

// Procesar archivo
const reader = new FileReader();
reader.onload = (e) => {
try {
const data = new Uint8Array(e.target.result);
const workbook = XLSX.read(data, { type: 'array' });
const sheet = workbook.Sheets["Packing List"];

if (!sheet) {
throw new Error('La hoja "Packing List" no fue encontrada en el archivo');
}

const rawData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
this.procesarDatos(rawData);

} catch (error) {
console.error('Error al procesar archivo:', error);
NotificationSystem.show('error', `❌ Error: ${error.message}`);
this.resetFileInput();
} finally {
elements.loadingSpinner.style.display = 'none';
}
};

reader.readAsArrayBuffer(file);
}

static resetFileInput() {
const label = elements.fileLabel;
label.classList.remove('has-file');
label.innerHTML = '<i class="fas fa-upload"></i><span>Seleccionar Archivo Excel</span>';
elements.fileInput.value = '';
elements.startButton.disabled = true;
systemReady = false;
MetricsSystem.update();
}

static procesarDatos(rawData) {
const fardosUnicos = new Set();

// Extraer paquetes únicos del archivo Excel
for (let i = 12; i < rawData.length; i++) {
const fila = rawData[i];
if (fila && fila[1]) {
fardosUnicos.add(fila[1].toString().trim());
}
}

// Convertir a array de objetos
fardos = Array.from(fardosUnicos).map((paquete) => ({
paquete: paquete,
revisado: false,
timestamp: null
}));

if (fardos.length > 0) {
NotificationSystem.show('success', `✅ Se cargaron ${fardos.length} paquetes correctamente.`);
elements.startButton.disabled = false;
systemReady = true;
this.renderFardosList();
} else {
NotificationSystem.show('error', '❌ No se encontraron paquetes válidos en el archivo.');
systemReady = false;
}

MetricsSystem.update();
}

static renderFardosList() {
const grid = elements.fardosGrid;
grid.innerHTML = '';

fardos.forEach((fardo, index) => {
const item = document.createElement('div');
item.className = 'fardo-item';
item.textContent = fardo.paquete;
item.id = `fardo-${index}`;

if (fardo.revisado) {
item.classList.add('completed');
}

grid.appendChild(item);
});
}
}

// Sistema de cámara y escáner
class ScannerSystem {
static init() {
elements.startButton.addEventListener('click', this.handleStartScanner.bind(this));
}

static handleStartScanner() {
if (!systemReady) {
NotificationSystem.show('warning', '⚠️ Primero debe cargar un archivo Excel con los paquetes.');
return;
}

if (!isQuaggaStarted) {
NotificationSystem.hide();
this.startQuagga();
} else {
// Detener escáner si ya está iniciado
Quagga.stop();
isQuaggaStarted = false;
elements.startButton.innerHTML = '<i class="fas fa-camera"></i><span>Activar Escáner</span>';
elements.startButton.className = "btn btn-danger";
elements.cameraPlaceholder.style.display = "block";
}
}

static startQuagga() {
// Configuración mejorada para mejor detección
Quagga.init({
inputStream: {
name: "Live",
type: "LiveStream",
target: elements.cameraContainer,
constraints: {
width: { min: 640, ideal: 1280 },
height: { min: 480, ideal: 720 },
facingMode: "environment"
}
},
decoder: {
readers: [
"code_128_reader", 
"ean_reader", 
"ean_8_reader",
"code_39_reader",
"code_39_vin_reader",
"codabar_reader",
"upc_reader",
"upc_e_reader"
]
},
locator: {
patchSize: "medium",
halfSample: true
},
numOfWorkers: navigator.hardwareConcurrency || 4,
locate: true,
frequency: 10
}, (err) => {
if (err) {
console.error("Error al iniciar Quagga:", err);
NotificationSystem.show('error', '❌ Error al acceder a la cámara. Verifique los permisos.');
elements.cameraPlaceholder.style.display = "block";
return;
}

elements.cameraPlaceholder.style.display = "none";

const video = elements.cameraContainer.querySelector("video");
const canvas = elements.cameraContainer.querySelector("canvas");

if (video) {
video.style.display = "block";
video.style.width = "100%";
video.style.height = "100%";
video.style.objectFit = "cover";
}
if (canvas) {
canvas.style.display = "block";
canvas.style.position = "absolute";
canvas.style.top = "0";
canvas.style.left = "0";
canvas.style.width = "100%";
canvas.style.height = "100%";
}

Quagga.start();
isQuaggaStarted = true;

elements.startButton.innerHTML = '<i class="fas fa-stop"></i><span>Detener Escáner</span>';
elements.startButton.className = "btn btn-success";

NotificationSystem.show('success', '✅ Escáner activado. Apunte la cámara hacia los códigos de barras.');
});
}

static showScanNotification(message, type = 'success') {
const notification = elements.scanNotification;
notification.textContent = message;
notification.className = `scan-notification ${type}`;
notification.style.display = 'block';

setTimeout(() => {
notification.style.display = 'none';
}, type === 'warning' ? 1500 : 2000);
}

static processBarcodeDetection(code) {
const cleanCode = code.trim();
console.log('Código detectado:', cleanCode);

// Buscar el paquete en la lista
const fardoIndex = fardos.findIndex(f => f.paquete === cleanCode);

if (fardoIndex !== -1) {
const fardo = fardos[fardoIndex];

if (!fardo.revisado) {
// Marcar como completado
fardo.revisado = true;
fardo.timestamp = new Date();

// Actualizar UI
const fardoElement = document.getElementById(`fardo-${fardoIndex}`);
if (fardoElement) {
fardoElement.classList.add('completed');
}

// Efectos de éxito
SoundSystem.playBeep();
this.showScanNotification(`✅ Paquete ${cleanCode} registrado correctamente`, 'success');

// Vibración
if ('vibrate' in navigator) {
navigator.vibrate([100]);
}

// Actualizar métricas
MetricsSystem.update();

} else {
// Ya fue escaneado
SoundSystem.playBeep();
this.showScanNotification(`⚠️ Paquete ${cleanCode} ya fue registrado`, 'warning');
}
} else {
// Paquete no encontrado
this.showScanNotification(`❌ Paquete ${cleanCode} no está en la lista`, 'error');
}
}
}

// Variables para evitar detecciones múltiples
let lastDetectedCode = null;
let lastDetectedTime = 0;
const DETECTION_COOLDOWN = 2000; // 2 segundos entre detecciones del mismo código

// Evento de detección de código de barras
Quagga.onDetected(function(result) {
const code = result.codeResult.code;
const currentTime = Date.now();

// Evitar detecciones repetidas
if (code === lastDetectedCode && (currentTime - lastDetectedTime) < DETECTION_COOLDOWN) {
return;
}

lastDetectedCode = code;
lastDetectedTime = currentTime;

// Procesar el código detectado
ScannerSystem.processBarcodeDetection(code);
});

// Dibujar overlay en la cámara
Quagga.onProcessed(function (result) {
const drawingCtx = Quagga.canvas.ctx.overlay;
const drawingCanvas = Quagga.canvas.dom.overlay;

if (!drawingCtx || !drawingCanvas) return;

drawingCtx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);

// Dibujar cuadro de escaneo fijo en el centro
const rectWidth = drawingCanvas.width * 0.7;
const rectHeight = drawingCanvas.height * 0.3;
const rectX = (drawingCanvas.width - rectWidth) / 2;
const rectY = (drawingCanvas.height - rectHeight) / 2;

// Cuadro principal
drawingCtx.lineWidth = 3;
drawingCtx.strokeStyle = '#10b981';
drawingCtx.fillStyle = 'rgba(16, 185, 129, 0.1)';
drawingCtx.fillRect(rectX, rectY, rectWidth, rectHeight);
drawingCtx.strokeRect(rectX, rectY, rectWidth, rectHeight);

// Esquinas del cuadro de escaneo
const cornerLength = 20;
const cornerThickness = 4;
drawingCtx.lineWidth = cornerThickness;
drawingCtx.strokeStyle = '#ffffff';

// Esquina superior izquierda
drawingCtx.beginPath();
drawingCtx.moveTo(rectX, rectY + cornerLength);
drawingCtx.lineTo(rectX, rectY);
drawingCtx.lineTo(rectX + cornerLength, rectY);
drawingCtx.stroke();

// Esquina superior derecha
drawingCtx.beginPath();
drawingCtx.moveTo(rectX + rectWidth - cornerLength, rectY);
drawingCtx.lineTo(rectX + rectWidth, rectY);
drawingCtx.lineTo(rectX + rectWidth, rectY + cornerLength);
drawingCtx.stroke();

// Esquina inferior izquierda
drawingCtx.beginPath();
drawingCtx.moveTo(rectX, rectY + rectHeight - cornerLength);
drawingCtx.lineTo(rectX, rectY + rectHeight);
drawingCtx.lineTo(rectX + cornerLength, rectY + rectHeight);
drawingCtx.stroke();

// Esquina inferior derecha
drawingCtx.beginPath();
drawingCtx.moveTo(rectX + rectWidth - cornerLength, rectY + rectHeight);
drawingCtx.lineTo(rectX + rectWidth, rectY + rectHeight);
drawingCtx.lineTo(rectX + rectWidth, rectY + rectHeight - cornerLength);
drawingCtx.stroke();

// Texto de instrucción
drawingCtx.fillStyle = '#ffffff';
drawingCtx.font = '16px Arial';
drawingCtx.textAlign = 'center';
drawingCtx.fillText('Coloque el código de barras dentro del marco', 
                   drawingCanvas.width / 2, rectY - 10);

// Dibujar códigos detectados
if (result) {
if (result.boxes) {
result.boxes
.filter((box) => box !== result.box)
.forEach((box) => {
drawingCtx.strokeStyle = "rgba(255, 255, 255, 0.4)";
drawingCtx.lineWidth = 2;
drawingCtx.beginPath();
box.forEach((point, index) => {
if (index === 0) {
drawingCtx.moveTo(point[0], point[1]);
} else {
drawingCtx.lineTo(point[0], point[1]);
}
});
drawingCtx.closePath();
drawingCtx.stroke();
});
}

if (result.box) {
drawingCtx.strokeStyle = "#00ff00";
drawingCtx.lineWidth = 3;
drawingCtx.beginPath();
result.box.forEach((point, index) => {
if (index === 0) {
drawingCtx.moveTo(point[0], point[1]);
} else {
drawingCtx.lineTo(point[0], point[1]);
}
});
drawingCtx.closePath();
drawingCtx.stroke();
}

if (result.codeResult && result.codeResult.code) {
drawingCtx.fillStyle = "#00ff00";
drawingCtx.font = "bold 16px Arial";
drawingCtx.textAlign = "left";
drawingCtx.fillText(result.codeResult.code, 10, 30);
}
}
});

// Inicialización del sistema
document.addEventListener('DOMContentLoaded', function() {
console.log('Inicializando KALAF SOFT System...');
    
// Verificar disponibilidad de APIs necesarias
if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
NotificationSystem.show('error', '❌ Tu navegador no soporta acceso a cámara. Usa Chrome o Firefox moderno.');
return;
}

// Inicializar módulos
SoundSystem.init(); // Inicializar sistema de sonido
FileSystem.init();
ScannerSystem.init();
MetricsSystem.update();

console.log('Sistema inicializado correctamente');
NotificationSystem.show('success', '✅ Sistema KALAF SOFT listo. Carga un archivo Excel para comenzar.', 3000);
});

// Manejo de errores globales
window.addEventListener('error', function(e) {
console.error('Error global:', e.error);
NotificationSystem.show('error', '❌ Se produjo un error en el sistema. Recarga la página si persiste.');
});

// Manejo de permisos de cámara
navigator.permissions?.query({name: 'camera'}).then(function(result) {
console.log('Estado de permisos de cámara:', result.state);
if (result.state === 'denied') {
NotificationSystem.show('warning', '⚠️ Los permisos de cámara están denegados. Habilítalos en la configuración del navegador.');
}
});

// Optimizaciones de rendimiento
if ('requestIdleCallback' in window) {
requestIdleCallback(() => {
console.log('Optimizaciones de rendimiento aplicadas');
});
}

// Prevenir zoom en dispositivos móviles
document.addEventListener('touchstart', function(event) {
if (event.touches.length > 1) {
event.preventDefault();
}
});

let lastTouchEnd = 0;
document.addEventListener('touchend', function(event) {
const now = (new Date()).getTime();
if (now - lastTouchEnd <= 300) {
event.preventDefault();
}
lastTouchEnd = now;
}, false);
</script>
</body>
</html>
